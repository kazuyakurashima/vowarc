# 003: ホーム画面

## 概要

ユーザーが毎日アクセスするホーム画面。北極星（Meaning Statement）、今日の最小コミット、Small Winsの概要を表示する。

## Phase

**Phase A: MVP**

## 優先度

高

## 依存関係

- 前提: 001 基盤構築, 002 Day0 Initiation
- 後続: 007 Day21 Judgment Gate, 010 Small Wins基本

---

## 機能要件

### 1. 北極星表示（Meaning Statement）

- 現在のMeaning Statement（1-2文）を常時表示
- 毎日リマインドとして機能
- タップで編集履歴を表示（v1→v2→...）

### 2. 今日の最小コミット

- その日に達成すべき最小タスク
- If-Then形式で表示
  - 例: 「もし朝起きたら、10分だけコードを書く」
- 完了チェックボックス
- 新規追加ボタン

### 3. Vow（誓い）表示

- 契約時に作成したVowをカード形式で表示
- タップで全文表示

### 4. 進捗サマリー

- 現在のDay数（Day X / 84）
- 現在のPhase（Trial / Week 4-8 / Week 9-12）
- チェックイン継続日数

### 5. クイックアクション

- **音声チェックインボタン**（大きく目立つ）
  - 004 音声チェックインへ遷移
  - If-Then記録を含む完全版
- **テキストチェックインボタン**
  - 簡易テキスト入力版チェックイン
  - **完了時にIf-Then記録質問も表示**（音声版と同様）
- **Evidence追加ボタン**

### 6. テキストチェックイン（簡易版） ← 追加

**要件背景:**
- 音声チェックイン（004）が主体だが、テキスト入力の選択肢も提供
- If-Then記録は音声版と同様に必須（010 Small Wins連携）

**フロー:**
1. テキスト入力欄に今日の振り返りを記入
2. 送信後、**AIがMirror Feedbackで応答**（簡易版）:
   - **観測変化・仮説・次の実験・Evidence Links**（4要素必須）を短く表示
   - 音声版（004）のような詳細分析・波形ビジュアル等は不要
3. **If-Then記録質問を表示**（004と同一UI）:
   - 「今日、予定していた障害（誘惑、時間不足等）に遭遇しましたか？」
     - [ ] はい / [ ] いいえ
   - 「はい」の場合: 「事前に決めていたIf-Thenを実行できましたか？」
     - [ ] 実行できた / [ ] 実行できなかった
4. `checkins.if_then_triggered = true/false` として保存
5. ホームへ戻る

**実装方針:**
- モーダルまたは別画面でテキスト入力
- **AI応答は簡易版Mirror Feedback（4要素必須）**（requirements.md必須要件）
  - Observed Change / Hypothesis / Next Experiment / Evidence Links
  - 表示は簡潔に（音声版のような長文・詳細分析は不要）
- If-Then質問は音声版（004）と同一コンポーネント使用

---

## UI/UX要件

### レイアウト構成

```
┌─────────────────────────────┐
│  [Day 15 / 84]  Phase: Trial │
├─────────────────────────────┤
│                              │
│  "意志を、物語に変える"       │
│  (Meaning Statement)         │
│                              │
├─────────────────────────────┤
│  今日の最小コミット            │
│  ┌───────────────────────┐  │
│  │ [ ] If 朝起きたら...    │  │
│  │     Then 10分書く       │  │
│  └───────────────────────┘  │
│  [+ 追加]                    │
├─────────────────────────────┤
│  あなたの誓い                 │
│  "私は〇〇を卒業し..."        │
├─────────────────────────────┤
│                              │
│    [🎤 チェックイン]           │
│                              │
└─────────────────────────────┘
```

### デザイン原則

- 余白を多く、情報過多にしない
- 抽象的なビジュアル（波形、グラデーション）
- Quiet Luxury: 静かで高級感のあるデザイン

### ホーム画面デザイン仕様

**カラー・余白**
- 背景: Ecru #F7F3F0（温かみのある白）
- サーフェス: Pearl #FAF8F5（カード等）
- Type-to-Space Ratio: 15:85（テキスト15%、余白85%）
- 低彩度（<8%）、アクセント色は控えめに

**タイポグラフィ**
- Meaning Statement: Noto Serif JP (Light) — 北極星として品格ある表示
- コミット内容/本文: Noto Sans JP (Regular)
- 数値/Day表示: Inter
- Line Height: 1.9〜2.1

**カード・Elevation**
- 影ではなく明度差で奥行きを表現
- カード背景: Surface色（Pearl #FAF8F5）
- ボーダー: 使用しない or 非常に薄い

**チェックインボタン**
- 大きく目立つ配置（画面下部中央）
- 音声チェックイン: プライマリ（より目立つ）
- テキストチェックイン: セカンダリ（控えめ）

**トランジション**
- 画面ロード: フェードイン 600ms
- カード表示: 順次フェードイン（100ms delay）
- ボタンタップ: 軽いハプティックフィードバック

**禁止事項**
- 派手なバッジ、ゲーミフィケーション要素
- 高彩度のアクセントカラー
- 情報過多なダッシュボード表示

---

## データ取得

### ホーム画面表示時の取得項目

1. **ユーザー情報**
   - current_phase
   - trial_start_date（Day計算用）

2. **Meaning Statement**
   - 最新のis_current = true のレコード

3. **Vow**
   - 最新のis_current = true のレコード

4. **今日のコミットメント**
   - due_date = today のレコード
   - status でフィルタ

5. **チェックイン履歴**
   - 継続日数計算用

---

## API設計

### GET /api/home

```json
{
  "user": {
    "id": "uuid",
    "current_phase": "trial",
    "day_number": 15,
    "checkin_streak": 12
  },
  "meaning_statement": {
    "content": "意志を、物語に変える",
    "version": 2
  },
  "vow": {
    "content": "私はこの3ヶ月で...",
    "version": 1
  },
  "today_commitments": [
    {
      "id": "uuid",
      "content": "If 朝起きたら Then 10分コードを書く",
      "status": "pending"
    }
  ]
}
```

---

## Todo

### 画面実装
- [x] ホーム画面レイアウト作成
- [x] Day数・Phase表示コンポーネント
- [x] Meaning Statement表示コンポーネント
- [x] Vow表示コンポーネント
- [x] 今日のコミット一覧コンポーネント
- [x] クイックアクションボタン（音声・テキスト両対応）
- [x] テキストチェックイン画面（4ステップフロー実装）
- [x] If-Then記録質問コンポーネント（004と共通、2ステップ質問実装）

### データ連携
- [x] ホームデータ取得hook作成（useHomeData集約hook実装）
- [ ] コミットメント完了API連携
- [ ] コミットメント追加モーダル
- [x] テキストチェックイン保存API連携（if_then_triggered含む、JWT認証実装）

### AI連携
- [x] Mirror Feedback生成サービス実装（4要素: Observed Change, Hypothesis, Next Experiment, Evidence Links）
- [x] Mirror Feedback生成API実装（/api/checkins/generate-mirror-feedback）
- [x] MirrorFeedbackDisplayコンポーネント実装

### セキュリティ修正
- [x] テキストチェックインのJWT認証実装（direct Supabase insertから変更）
- [x] save API経由でのユーザーID検証
- [x] メモリー抽出のJWT認証対応

### UI/UX
- [ ] アニメーション（フェードイン等）
- [x] Quiet Luxuryテーマ適用（Ecru基調、低彩度）
- [ ] 波形/抽象ビジュアル背景

---

## 完了条件

1. Meaning Statementが表示される
2. Vowが表示される
3. 今日のコミットメントが一覧表示される
4. コミットメントを完了マークできる
5. 音声チェックインボタンから004へ遷移できる
6. **テキストチェックインが完了し、If-Then記録質問が表示される** ← 追加
7. **テキストチェックイン完了時にif_then_triggeredが保存される** ← 追加
8. Day数とPhaseが正しく計算・表示される
