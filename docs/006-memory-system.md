# 006: äºŒå±¤è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ ï¼ˆåŸºæœ¬ç‰ˆï¼‰

## æ¦‚è¦

AIãŒéå»ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
ç›´è¿‘7æ—¥ï¼ˆShort-termï¼‰ã¨è¦æ‰€ï¼ˆMilestonesï¼‰ã®äºŒå±¤æ§‹é€ ã§ç®¡ç†ã€‚

## Phase

**Phase A: MVP**

## å„ªå…ˆåº¦

ä¸­

## ä¾å­˜é–¢ä¿‚

- å‰æ: 001 åŸºç›¤æ§‹ç¯‰
- å¾Œç¶š: 004 éŸ³å£°ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³, 005 AIã‚³ãƒ¼ãƒ, 007 Day21 Gate, 017 é«˜åº¦ãªWitness Memory

---

## æ©Ÿèƒ½è¦ä»¶

### 1. äºŒå±¤è¨˜æ†¶æ§‹é€ 

**Short-termï¼ˆç›´è¿‘7æ—¥ï¼‰:**
- è¦ç´„
- ã‚³ãƒŸãƒƒãƒˆç™ºè¨€
- æ°—åˆ†
- éšœå®³
- Small Wins

**Milestonesï¼ˆè¦æ‰€ï¼‰:**
- Vowï¼ˆèª“ã„ï¼‰
- ä¾¡å€¤è¦³
- é€ƒã’ç™–ï¼ˆAnti-Patternï¼‰
- è»¢æ©Ÿ
- æˆæœç‰©
- é‡å¤§ãªç´„æŸ

### 2. Mutable / Immutable åˆ†é›¢

**Mutable Layerï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†å¯ï¼‰:**
- Meaning Statement ã®æ–‡è¨€
- Vow ã®è¡¨ç¾
- æ„Ÿæƒ…çš„æ³¨é‡ˆãƒ»è§£é‡ˆ
- ç·¨é›†æ™‚ã¯å¿…ãšå±¥æ­´ã‚’ç”Ÿæˆ

**Immutable Layerï¼ˆæ”¹ã–ã‚“ä¸å¯ï¼‰:**
- ã‚³ãƒŸãƒƒãƒˆç™ºè¨€ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰
- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³è¨˜éŒ²
- Evidenceæå‡ºç‰©
- Mutable Layerã®ç·¨é›†å±¥æ­´

### 3. ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹è¨˜æ†¶

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAIã®è¨˜æ†¶ã‚’é–²è¦§å¯èƒ½
- ç·¨é›†å¯èƒ½ãªé …ç›®ã®ç·¨é›†æ©Ÿèƒ½
- ç·¨é›†å±¥æ­´ã®è¡¨ç¤º

### 4. å‰Šé™¤æ¨©ã¨è¨¼äººæ€§ã®ä¸¡ç«‹ï¼ˆMVPæœ€ä½é™ï¼‰ â† è¿½åŠ 

**è¦ä»¶èƒŒæ™¯:**
- requirements.md ã§æ³•çš„/åŒ»ç™‚çš„ç†ç”±ã§ã®å‰Šé™¤ãŒå¿…é ˆï¼ˆMVPç¯„å›²ï¼‰
- UIã¯ä¸è¦ã€ç®¡ç†è€…å‘ã‘æ©Ÿèƒ½ã¨ã—ã¦å®Ÿè£…

**åŸå‰‡:**
- Immutable Layerã¯åŸå‰‡å‰Šé™¤ä¸å¯
- ä¾‹å¤–å‰Šé™¤ã®ç¯„å›²ï¼ˆMVPï¼‰:
  1. **æ³•çš„è¦è«‹**ï¼ˆGDPRç­‰ã®å¿˜ã‚Œã‚‰ã‚Œã‚‹æ¨©åˆ©ï¼‰
  2. **åŒ»ç™‚çš„å±æ©Ÿ/ãƒˆãƒ©ã‚¦ãƒé–¢é€£è¨˜éŒ²**ï¼ˆå®‰å…¨é…æ…®ï¼‰

**å‰Šé™¤æ™‚ã®å‡¦ç†:**
- å®Œå…¨å‰Šé™¤ï¼ˆå†…å®¹æ¶ˆå»ï¼‰
- Tombstoneï¼ˆå‰Šé™¤ç—•è·¡ï¼‰ã‚’ä¿æŒ:
  - ã€Œã€‡æœˆã€‡æ—¥ã«è¨˜éŒ²ã‚ã‚Šï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰ã€
  - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼ˆå†…å®¹ãƒ»ã‚«ãƒ†ã‚´ãƒªã¯å«ã¾ãªã„ï¼‰

**å®Ÿè£…æ–¹é‡ï¼ˆMVPï¼‰:**
- ç®¡ç†è€…å‘ã‘APIï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰ã¨ã—ã¦å®Ÿè£…
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘å‰Šé™¤è¦è«‹UIã¯ Phase Bï¼ˆ017ï¼‰
- ç›£æŸ»ãƒ­ã‚°ã§å‰Šé™¤è¦è«‹ã®è¨˜éŒ²ã‚’ä¿æŒ

### 5. è¨˜æ†¶ã®è¦ç´„ç”Ÿæˆ

- æ—¥æ¬¡ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‹ã‚‰è¦ç´„ã‚’è‡ªå‹•ç”Ÿæˆ
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
- æ„Ÿæƒ…ãƒˆãƒ¼ãƒ³åˆ†æ

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### memories ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE memories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  type VARCHAR(50) NOT NULL, -- 'short_term' | 'milestone'
  category VARCHAR(50) NOT NULL, -- 'commitment' | 'mood' | 'obstacle' | 'win' | 'vow' | 'value' | 'anti_pattern' | 'turning_point' | 'achievement'
  content TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  is_mutable BOOLEAN DEFAULT false,
  source_id UUID, -- å…ƒã®checkinã‚„evidenceã®ID
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP, -- short_termã®å ´åˆã¯7æ—¥å¾Œ
  is_active BOOLEAN DEFAULT true
);
```

### memory_versions ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç·¨é›†å±¥æ­´ï¼‰

```sql
CREATE TABLE memory_versions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  memory_id UUID REFERENCES memories(id) NOT NULL,
  version INTEGER NOT NULL,
  content TEXT NOT NULL,
  edited_at TIMESTAMP DEFAULT NOW(),
  edited_by UUID REFERENCES users(id)
);
```

### tombstones ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‰Šé™¤ç—•è·¡ï¼‰

```sql
CREATE TABLE tombstones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  original_memory_id UUID NOT NULL,
  user_id UUID REFERENCES users(id) NOT NULL,
  deletion_reason VARCHAR(50) NOT NULL, -- 'legal' | 'medical'
  deleted_at TIMESTAMP DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'
);
```

### deletion_requests ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‰Šé™¤è¦è«‹è¨˜éŒ²ï¼‰ â† è¿½åŠ 

```sql
CREATE TABLE deletion_requests (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  memory_id UUID REFERENCES memories(id),
  reason_category VARCHAR(50) NOT NULL, -- 'legal' | 'medical'
  reason_detail TEXT,
  status VARCHAR(50) DEFAULT 'pending', -- 'pending' | 'approved' | 'rejected'
  requested_at TIMESTAMP DEFAULT NOW(),
  processed_at TIMESTAMP,
  processed_by VARCHAR(100) -- ç®¡ç†è€…è­˜åˆ¥å­ï¼ˆemailç­‰ï¼‰
);
```

### audit_logs ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç›£æŸ»ãƒ­ã‚°ãƒ»å†…éƒ¨ç”¨ï¼‰ â† è¿½åŠ 

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  action VARCHAR(100) NOT NULL, -- 'memory_deleted' | 'deletion_requested' | 'deletion_approved' | 'deletion_rejected'
  target_type VARCHAR(50), -- 'memory' | 'user' | 'system'
  target_id UUID,
  details JSONB,
  performed_by VARCHAR(100), -- ç®¡ç†è€…è­˜åˆ¥å­ or 'system'
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## APIè¨­è¨ˆ

### GET /api/memories

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨˜æ†¶ã‚’å–å¾—

**Query Parameters:**
- `type`: 'short_term' | 'milestone' | 'all'
- `limit`: æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ï¼‰

**Response:**
```json
{
  "short_term": [
    {
      "id": "uuid",
      "category": "commitment",
      "content": "æ˜æ—¥ã¯5æ™‚ã«èµ·ãã‚‹",
      "created_at": "2024-01-05T20:00:00Z",
      "source_type": "checkin"
    }
  ],
  "milestones": [
    {
      "id": "uuid",
      "category": "vow",
      "content": "ç§ã¯ã“ã®3ãƒ¶æœˆã§...",
      "version": 2,
      "created_at": "2024-01-01T10:00:00Z"
    }
  ]
}
```

### POST /api/memories

è¨˜æ†¶ã‚’è¿½åŠ 

**Request:**
```json
{
  "type": "milestone",
  "category": "anti_pattern",
  "content": "ç· ã‚åˆ‡ã‚ŠãŒè¿‘ã¥ãã¨é€ƒã’ã‚‹å‚¾å‘",
  "metadata": {
    "detected_from": "checkin_123"
  }
}
```

### PUT /api/memories/:id

ç·¨é›†å¯èƒ½ãªè¨˜æ†¶ã‚’æ›´æ–°ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã‚’ç”Ÿæˆï¼‰

**Request:**
```json
{
  "content": "æ›´æ–°ã•ã‚ŒãŸå†…å®¹"
}
```

### GET /api/memories/:id/versions

ç·¨é›†å±¥æ­´ã‚’å–å¾—

### POST /api/admin/memories/:id/deleteï¼ˆç®¡ç†è€…ç”¨ï¼‰ â† è¿½åŠ 

**èªè¨¼è¦ä»¶:** ç®¡ç†è€…æ¨©é™å¿…é ˆ

è¨˜æ†¶ã‚’ä¾‹å¤–çš„ã«å‰Šé™¤ã—ã€Tombstoneã‚’ç”Ÿæˆã™ã‚‹

**Request:**
```json
{
  "reason_category": "legal",
  "reason_detail": "GDPRå¿˜ã‚Œã‚‰ã‚Œã‚‹æ¨©åˆ©ã®è¦è«‹",
  "performed_by": "admin@example.com"
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**
1. å¯¾è±¡è¨˜æ†¶ã®å†…å®¹ã‚’å®Œå…¨å‰Šé™¤ï¼ˆ`content` ã‚’ç©ºã«ã—ã€`is_active` ã‚’ falseï¼‰
2. Tombstoneãƒ¬ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆæ—¥æ™‚ã®ã¿ä¿æŒï¼‰
3. Audit Logã«è¨˜éŒ²
4. Deletion Requestã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ 'approved' ã«æ›´æ–°

**Response:**
```json
{
  "success": true,
  "tombstone_id": "uuid",
  "audit_log_id": "uuid"
}
```

---

## è¨˜æ†¶æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯

### ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‹ã‚‰ã®è‡ªå‹•æŠ½å‡º

```typescript
interface MemoryExtraction {
  commitments: string[];      // ã€Œã€œã™ã‚‹ã€ã€Œã€œã‚„ã‚‹ã€ç­‰ã®ã‚³ãƒŸãƒƒãƒˆç™ºè¨€
  obstacles: string[];        // ã€Œã€œãŒé›£ã—ã„ã€ã€Œã€œãŒã§ããªã„ã€ç­‰ã®éšœå®³
  wins: string[];             // é”æˆå ±å‘Šã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå¤‰åŒ–
  mood: number;               // 1-5ã®æ„Ÿæƒ…ã‚¹ã‚³ã‚¢
  summary: string;            // å…¨ä½“è¦ç´„
}

async function extractMemories(
  checkinContent: string,
  aiClient: OpenAI
): Promise<MemoryExtraction> {
  // AIã‚’ä½¿ã£ã¦æ§‹é€ åŒ–æŠ½å‡º
  const prompt = `
ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å†…å®¹ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„:

${checkinContent}

JSONå½¢å¼ã§ä»¥ä¸‹ã‚’è¿”ã—ã¦ãã ã•ã„:
- commitments: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆç™ºè¨€ï¼ˆã€Œã€œã™ã‚‹ã€ã€Œã€œã‚„ã‚‹ã€ç­‰ï¼‰
- obstacles: éšœå®³ã‚„å›°é›£ï¼ˆã€Œã€œãŒé›£ã—ã„ã€ç­‰ï¼‰
- wins: é”æˆã‚„æˆåŠŸä½“é¨“
- mood: æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆ1=éå¸¸ã«æ‚ªã„ã€œ5=éå¸¸ã«è‰¯ã„ï¼‰
- summary: 50æ–‡å­—ä»¥å†…ã®è¦ç´„
`;

  // APIå‘¼ã³å‡ºã—ã¨ãƒ‘ãƒ¼ã‚¹
}
```

### 7æ—¥çµŒéå¾Œã®å‡¦ç†

```typescript
// æ—¥æ¬¡ãƒãƒƒãƒã¾ãŸã¯cron
async function expireOldMemories() {
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

  await supabase
    .from('memories')
    .update({ is_active: false })
    .eq('type', 'short_term')
    .lt('created_at', sevenDaysAgo.toISOString());
}
```

---

## UI: è¨˜æ†¶é–²è¦§ç”»é¢

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚ãªãŸã®è¨˜æ†¶               â”‚
â”‚  [ç›´è¿‘7æ—¥] [è¦æ‰€]           â”‚ â† ã‚¿ãƒ–åˆ‡æ›¿
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  ğŸ“… 1æœˆ5æ—¥                   â”‚
â”‚  â”œ ã‚³ãƒŸãƒƒãƒˆ: 5æ™‚ã«èµ·ãã‚‹    â”‚
â”‚  â”œ æ°—åˆ†: ğŸ˜ (3/5)           â”‚
â”‚  â”” éšœå®³: å¤œæ›´ã‹ã—           â”‚
â”‚                              â”‚
â”‚  ğŸ“… 1æœˆ4æ—¥                   â”‚
â”‚  â”œ Win: 10åˆ†ã‚³ãƒ¼ãƒ‰æ›¸ã‘ãŸ!   â”‚
â”‚  â”” æ°—åˆ†: ğŸ˜Š (4/5)           â”‚
â”‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ç·¨é›†] [ä»‹å…¥è¨­å®š]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Todo

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
- [x] memories ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [x] memory_versions ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [x] tombstones ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [x] deletion_requests ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ â† è¿½åŠ 
- [x] audit_logs ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ â† è¿½åŠ 
- [x] RLSè¨­å®šï¼ˆç®¡ç†è€…æ¨©é™è¨­å®šå«ã‚€ï¼‰

### è¨˜æ†¶æŠ½å‡º
- [x] ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‹ã‚‰ã®è‡ªå‹•æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯
- [x] è¦ç´„ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
- [x] æ„Ÿæƒ…ã‚¹ã‚³ã‚¢åˆ†æ

### APIå®Ÿè£…
- [ ] GET /api/memories
- [ ] POST /api/memories
- [ ] PUT /api/memories/:id
- [ ] GET /api/memories/:id/versions
- [ ] POST /api/admin/memories/:id/deleteï¼ˆç®¡ç†è€…ç”¨ï¼‰ â† è¿½åŠ 

### å‰Šé™¤æ¨©ãƒ»ç›£æŸ»ï¼ˆMVPæœ€ä½é™ï¼‰ â† è¿½åŠ 
- [ ] ç®¡ç†è€…å‘ã‘å‰Šé™¤å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
- [ ] Tombstoneç”Ÿæˆå‡¦ç†
- [ ] Audit Logè¨˜éŒ²å‡¦ç†
- [ ] å‰Šé™¤è¦è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†

### è¨˜æ†¶ç®¡ç†
- [ ] 7æ—¥çµŒéå¾Œã®éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–å‡¦ç†
- [ ] Milestoneæ˜‡æ ¼ãƒ­ã‚¸ãƒƒã‚¯

### UIå®Ÿè£…
- [ ] è¨˜æ†¶é–²è¦§ç”»é¢
- [ ] ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
- [ ] ç·¨é›†å±¥æ­´è¡¨ç¤º

---

## å®Œäº†æ¡ä»¶

1. ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‹ã‚‰è‡ªå‹•çš„ã«è¨˜æ†¶ãŒæŠ½å‡ºã•ã‚Œã‚‹
2. ç›´è¿‘7æ—¥ã®è¨˜æ†¶ãŒå–å¾—ã§ãã‚‹
3. Milestoneè¨˜æ†¶ãŒæ°¸ç¶šåŒ–ã•ã‚Œã‚‹
4. ç·¨é›†å¯èƒ½ãªè¨˜æ†¶ã®ç·¨é›†ã¨å±¥æ­´ä¿æŒãŒã§ãã‚‹
5. AIã‚³ãƒ¼ãƒãŒè¨˜æ†¶ã‚’å‚ç…§ã§ãã‚‹
6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨˜æ†¶ã‚’é–²è¦§ã§ãã‚‹
7. **ç®¡ç†è€…ãŒæ³•çš„/åŒ»ç™‚çš„ç†ç”±ã§è¨˜æ†¶ã‚’å‰Šé™¤ã§ãã‚‹** â† è¿½åŠ 
8. **å‰Šé™¤æ™‚ã«Tombstoneã¨ç›£æŸ»ãƒ­ã‚°ãŒç”Ÿæˆã•ã‚Œã‚‹** â† è¿½åŠ 

### ãƒ‡ãƒ¼ã‚¿Hooksï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
- [x] useMemories hookä½œæˆï¼ˆSupabase SDKç›´æ¥ä½¿ç”¨ï¼‰
- [x] useMemoriesByType hookä½œæˆ

### ãƒ¡ãƒ¢
- APIå®Ÿè£…ã¯ç›´æ¥Supabase SDKã‚’ä½¿ç”¨ã™ã‚‹æ–¹é‡ã«å¤‰æ›´ï¼ˆRLS-safeï¼‰
- POST /api/memories/extract ã®ã¿ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰APIï¼ˆOpenAIå‘¼ã³å‡ºã—ã®ãŸã‚ï¼‰
- ç®¡ç†è€…å‘ã‘å‰Šé™¤æ©Ÿèƒ½ã¯Phase Bã§å®Ÿè£…äºˆå®š
