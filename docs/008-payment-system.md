# 008: èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ ï¼ˆä¸€æ‹¬æ‰•ã„ï¼‰

## æ¦‚è¦

Day 10ã®æ±ºæ¸ˆæƒ…å ±ç™»éŒ²ï¼ˆä»»æ„ï¼‰ã¨Day 21ã®**ä¸€æ‹¬èª²é‡‘**ã‚’å®Ÿè£…ã™ã‚‹ã€‚å„€å¼ä½“é¨“ã¨èª²é‡‘ã‚’åˆ†é›¢ã—ã€ãƒ€ãƒ¼ã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å›é¿ã™ã‚‹è¨­è¨ˆã€‚

## Phase

**Phase A: MVP**

## å„ªå…ˆåº¦

é«˜

## ä¾å­˜é–¢ä¿‚

- å‰æ: 007 Day21 Judgment Gate
- å¾Œç¶š: ãªã—ï¼ˆMVPå®Œçµï¼‰

---

## æ©Ÿèƒ½è¦ä»¶

### 1. 3æ®µéšã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆãƒ»ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```
Day 0        Day 10              Day 21
  â”‚            â”‚                   â”‚
  â–¼            â–¼                   â–¼
[é–‹å§‹]      [æ±ºæ¸ˆæƒ…å ±ç™»éŒ²]      [å„€å¼ â†’ ä¸€æ‹¬èª²é‡‘]
æœ€å°å…¥åŠ›     èª²é‡‘ã¯ã—ãªã„        ç¶™ç¶šé¸æŠã§9é€±é–“åˆ†ä¸€æ‹¬
```

### 2. Day 10 æ±ºæ¸ˆæƒ…å ±ç™»éŒ²ï¼ˆä»»æ„ï¼‰

**ãƒˆãƒªã‚¬ãƒ¼:**
- 10æ—¥ç›®ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†æ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º

**å¿…é ˆè¡¨ç¤ºæ–‡è¨€:**
```
10æ—¥é–“ã€ã‚ãªãŸã¯æˆ»ã£ã¦ãã¾ã—ãŸã€‚
Day 21ã«ç¶™ç¶šã‚’é¸ã‚“ã å ´åˆã«å‚™ãˆã€æ±ºæ¸ˆæƒ…å ±ã‚’ãŠé ã‹ã‚Šã—ã¾ã™ã€‚
ã“ã®æ™‚ç‚¹ã§ã¯èª²é‡‘ã•ã‚Œã¾ã›ã‚“ã€‚ã„ã¤ã§ã‚‚å–ã‚Šæ¶ˆã›ã¾ã™ã€‚
```

**ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆè¨­è¨ˆ:**
- ã€Œå¾Œã§ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æ˜ç¤º
- ã‚¹ã‚­ãƒƒãƒ—ã—ãŸå ´åˆã€Day 21ã®ç¶™ç¶šé¸æŠæ™‚ã«ç™»éŒ²ã‚’æ±‚ã‚ã‚‹

### 3. Day 21 ä¸€æ‹¬èª²é‡‘

**ç”»é¢åˆ†é›¢ï¼ˆé‡è¦ï¼‰:**
```
[å„€å¼å®Œäº†] â†’ [ç¶™ç¶šã‚’é¸æŠ] â†’ [æ±ºæ¸ˆç¢ºèªç”»é¢] â†’ [ä¸€æ‹¬èª²é‡‘]
              â†“
         [åœæ­¢ã‚’é¸æŠ] â†’ [Exit Ritual]
```

**æ±ºæ¸ˆç¢ºèªç”»é¢ã®è¡¨ç¤ºé …ç›®:**
- èª²é‡‘é¡ï¼ˆ9é€±é–“åˆ†ã®ä¸€æ‹¬æ‰•ã„ã€æ˜ç¤ºï¼‰
- æ±ºæ¸ˆæƒ…å ±ï¼ˆDay 10ç™»éŒ²æ¸ˆã¿ã®å ´åˆã¯è¡¨ç¤ºã€æœªç™»éŒ²ã®å ´åˆã¯å…¥åŠ›ï¼‰
- ã€Œèª²é‡‘ã‚’ç¢ºå®šã™ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆèƒ½å‹•çš„é¸æŠï¼‰

### 4. è§£ç´„ãƒ»è¿”é‡‘

- æœ‰æ–™æœŸé–“ä¸­ã¯ã„ã¤ã§ã‚‚è§£ç´„å¯èƒ½
- è§£ç´„æ™‚ãƒ¬ãƒ“ãƒ¥ãƒ¼å…¥åŠ›å¿…é ˆ
- è¿”é‡‘ãƒãƒªã‚·ãƒ¼ã®æ˜ç¤ºï¼ˆæ—¥å‰²ã‚Šè¿”é‡‘ãªã©ï¼‰

---

## èª²é‡‘ãƒ¢ãƒ‡ãƒ«

### æ–™é‡‘è¨­å®šï¼ˆMVPï¼‰

| é …ç›® | æœŸé–“ | ä¾¡æ ¼ |
|-----|------|------|
| ãƒˆãƒ©ã‚¤ã‚¢ãƒ« | Day 1-21ï¼ˆ3é€±é–“ï¼‰ | ç„¡æ–™ |
| æœ‰æ–™æœŸé–“ | Week 4-12ï¼ˆ9é€±é–“ï¼‰ | **Â¥19,800ï¼ˆä¸€æ‹¬æ‰•ã„ï¼‰** |

### èª²é‡‘ã‚¿ã‚¤ãƒŸãƒ³ã‚°

- **Day 21ã«ç¶™ç¶šã‚’é¸æŠã—ãŸæ™‚ç‚¹ã§9é€±é–“åˆ†ã‚’ä¸€æ‹¬èª²é‡‘**
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã§ã¯ãªãã€1å›ã®æ±ºæ¸ˆã§å®Œçµ

### è¿”é‡‘ãƒãƒªã‚·ãƒ¼

| è§£ç´„ã‚¿ã‚¤ãƒŸãƒ³ã‚° | è¿”é‡‘é¡ |
|--------------|--------|
| Week 4-5 | æ®‹ã‚Š7é€±é–“åˆ†ã®æ—¥å‰²ã‚Šè¿”é‡‘ |
| Week 6-8 | æ®‹ã‚Šé€±æ•°ã®æ—¥å‰²ã‚Šè¿”é‡‘ |
| Week 9-12 | è¿”é‡‘ãªã—ï¼ˆæœ€çµ‚ã‚¹ãƒ—ãƒªãƒ³ãƒˆæœŸé–“ï¼‰ |

> è¿”é‡‘ã¯ã€Œç½°ã€ã§ã¯ãªãã€åŒæ–¹ãŒæœ¬æ°—ã§æ”¹å–„ã—ç¶šã‘ã‚‹ãŸã‚ã®ã€Œèª å®Ÿãªçµ‚ã‚ã‚Šæ–¹ã€ã¨ã—ã¦è¨­è¨ˆã™ã‚‹ã€‚

---

## æŠ€è¡“é¸å®š

### æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€

**æ¨å¥¨: Stripeï¼ˆPaymentIntentï¼‰**
- ä¸€æ‹¬æ‰•ã„ã«æœ€é©
- React Nativeå¯¾å¿œï¼ˆ@stripe/stripe-react-nativeï¼‰
- æ—¥æœ¬å††å¯¾å¿œ

**ä»£æ›¿: RevenueCat**
- App Store / Google Playèª²é‡‘ã®çµ±åˆ
- ä¸€æ‹¬è³¼å…¥ï¼ˆNon-consumableï¼‰ã«ã‚‚å¯¾å¿œ

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### payment_methods ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE payment_methods (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  stripe_payment_method_id VARCHAR(255) NOT NULL,
  card_last4 VARCHAR(4),
  card_brand VARCHAR(50),
  is_default BOOLEAN DEFAULT true,
  registered_at TIMESTAMP DEFAULT NOW(),
  is_active BOOLEAN DEFAULT true
);
```

### payments ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  stripe_payment_intent_id VARCHAR(255),
  amount INTEGER NOT NULL,
  currency VARCHAR(3) DEFAULT 'jpy',
  status VARCHAR(50) NOT NULL, -- 'succeeded' | 'failed' | 'refunded' | 'partially_refunded'
  refunded_amount INTEGER DEFAULT 0,
  paid_period_weeks INTEGER DEFAULT 9, -- æ”¯æ‰•ã„å¯¾è±¡é€±æ•°
  created_at TIMESTAMP DEFAULT NOW()
);
```

### cancellation_reviews ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE cancellation_reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  payment_id UUID REFERENCES payments(id),
  reason_category VARCHAR(100) NOT NULL,
  free_text TEXT,
  expected_vs_reality TEXT,
  missing_support TEXT,
  refund_amount INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## APIè¨­è¨ˆ

### POST /api/payment/setup-intent

æ±ºæ¸ˆæƒ…å ±ç™»éŒ²ç”¨ã®SetupIntentä½œæˆ

**Response:**
```json
{
  "clientSecret": "seti_xxx_secret_xxx"
}
```

### POST /api/payment/save-method

æ±ºæ¸ˆæƒ…å ±ã‚’ä¿å­˜

**Request:**
```json
{
  "paymentMethodId": "pm_xxx"
}
```

### POST /api/payment/charge

Day 21ã§ä¸€æ‹¬èª²é‡‘ã‚’å®Ÿè¡Œ

**Request:**
```json
{
  "paymentMethodId": "pm_xxx", // Day 10ã§ç™»éŒ²æ¸ˆã¿ã®å ´åˆã¯ä¸è¦
  "amount": 19800 // é‡‘é¡ï¼ˆå††ï¼‰
}
```

**Response:**
```json
{
  "paymentId": "pay_xxx",
  "status": "succeeded",
  "amount": 19800
}
```

### POST /api/payment/refund

è§£ç´„æ™‚ã®è¿”é‡‘å‡¦ç†

**Request:**
```json
{
  "paymentId": "pay_xxx",
  "review": {
    "reason_category": "åŠ¹æœã‚’æ„Ÿã˜ãªã‹ã£ãŸ",
    "free_text": "...",
    "expected_vs_reality": "...",
    "missing_support": "..."
  }
}
```

**Response:**
```json
{
  "refundedAmount": 8800,
  "remainingWeeks": 4,
  "status": "partially_refunded"
}
```

---

## Stripeå®Ÿè£…

### Setup Intentï¼ˆDay 10ï¼‰

```typescript
import Stripe from 'stripe';
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

export async function createSetupIntent(customerId: string) {
  const setupIntent = await stripe.setupIntents.create({
    customer: customerId,
    payment_method_types: ['card'],
  });
  return setupIntent.client_secret;
}
```

### ä¸€æ‹¬èª²é‡‘ï¼ˆDay 21ï¼‰

```typescript
export async function chargeOneTime(
  customerId: string,
  paymentMethodId: string,
  amount: number
) {
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ”¯æ‰•ã„æ–¹æ³•ã‚’è¨­å®š
  await stripe.customers.update(customerId, {
    invoice_settings: { default_payment_method: paymentMethodId },
  });

  // PaymentIntentä½œæˆï¼†ç¢ºå®šï¼ˆä¸€æ‹¬æ‰•ã„ï¼‰
  const paymentIntent = await stripe.paymentIntents.create({
    amount: amount,
    currency: 'jpy',
    customer: customerId,
    payment_method: paymentMethodId,
    confirm: true,
    description: 'VowArc æœ‰æ–™æœŸé–“ï¼ˆ9é€±é–“ï¼‰',
  });

  return paymentIntent;
}
```

### è¿”é‡‘å‡¦ç†

```typescript
export async function processRefund(
  paymentIntentId: string,
  refundAmount: number
) {
  const refund = await stripe.refunds.create({
    payment_intent: paymentIntentId,
    amount: refundAmount,
  });

  return refund;
}

// è¿”é‡‘é¡è¨ˆç®—
export function calculateRefundAmount(
  totalAmount: number,
  paidWeeks: number,
  usedWeeks: number
): number {
  const remainingWeeks = paidWeeks - usedWeeks;
  if (remainingWeeks <= 0) return 0;

  // Week 9-12ã¯è¿”é‡‘ãªã—
  if (usedWeeks >= 6) return 0;

  // æ—¥å‰²ã‚Šè¨ˆç®—
  const weeklyRate = totalAmount / paidWeeks;
  return Math.floor(weeklyRate * remainingWeeks);
}
```

---

## UIè¨­è¨ˆ

### Day 10 ãƒ¢ãƒ¼ãƒ€ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  10æ—¥é–“ã€æˆ»ã£ã¦ãã¾ã—ãŸ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  Day 21ã«ç¶™ç¶šã‚’é¸ã‚“ã å ´åˆ    â”‚
â”‚  ã«å‚™ãˆã€æ±ºæ¸ˆæƒ…å ±ã‚’           â”‚
â”‚  ãŠé ã‹ã‚Šã—ã¾ã™ã€‚             â”‚
â”‚                              â”‚
â”‚  ã“ã®æ™‚ç‚¹ã§ã¯èª²é‡‘ã•ã‚Œã¾ã›ã‚“   â”‚
â”‚  ã„ã¤ã§ã‚‚å–ã‚Šæ¶ˆã›ã¾ã™         â”‚
â”‚                              â”‚
â”‚  [ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å…¥åŠ›]           â”‚
â”‚                              â”‚
â”‚  ã¾ãŸã¯                       â”‚
â”‚                              â”‚
â”‚  [å¾Œã§ç™»éŒ²]                   â”‚
â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Day 21 æ±ºæ¸ˆç¢ºèª

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èª²é‡‘ã®ç¢ºèª                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  ãƒ—ãƒ©ãƒ³: VowArc æœ‰æ–™ãƒ—ãƒ©ãƒ³   â”‚
â”‚  æœŸé–“: Week 4-12 (9é€±é–“)     â”‚
â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¸€æ‹¬æ‰•ã„: Â¥19,800     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚
â”‚  ğŸ’³ **** **** **** 1234      â”‚
â”‚     [åˆ¥ã®ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ã†]        â”‚
â”‚                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  è§£ç´„æ™‚ã¯æ®‹ã‚ŠæœŸé–“ã«å¿œã˜ã¦     â”‚
â”‚  æ—¥å‰²ã‚Šè¿”é‡‘ã„ãŸã—ã¾ã™ã€‚        â”‚
â”‚  ã‚ãªãŸã®èª“ã„ã¸ã®æŠ•è³‡ã§ã™ã€‚    â”‚
â”‚                              â”‚
â”‚  [èª²é‡‘ã‚’ç¢ºå®šã™ã‚‹]             â”‚
â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Todo

### Stripeè¨­å®š
- [ ] Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
- [ ] å•†å“è¨­å®šï¼ˆä¸€æ‹¬æ‰•ã„ç”¨ï¼‰
- [ ] Webhookè¨­å®š

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- [ ] payment_methods ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] payments ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] cancellation_reviews ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

### Day 10 å®Ÿè£…
- [ ] SetupIntent API
- [ ] æ±ºæ¸ˆæƒ…å ±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«
- [ ] ã‚«ãƒ¼ãƒ‰ä¿å­˜å‡¦ç†
- [ ] ã‚¹ã‚­ãƒƒãƒ—å‡¦ç†

### Day 21 å®Ÿè£…
- [ ] æ±ºæ¸ˆç¢ºèªç”»é¢
- [ ] ä¸€æ‹¬èª²é‡‘APIï¼ˆPaymentIntentï¼‰
- [ ] èª²é‡‘æˆåŠŸ/å¤±æ•—ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºæ›´æ–°

### è§£ç´„ãƒ»è¿”é‡‘å®Ÿè£…
- [ ] è§£ç´„ç”»é¢
- [ ] è§£ç´„ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ 
- [ ] è¿”é‡‘é¡è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
- [ ] è¿”é‡‘å‡¦ç†API

### Webhook
- [ ] payment_intent.succeeded
- [ ] charge.refunded

---

## å®Œäº†æ¡ä»¶

1. Day 10ã«æ±ºæ¸ˆæƒ…å ±ã‚’ä»»æ„ã§ç™»éŒ²ã§ãã‚‹
2. Day 10ã§ã‚¹ã‚­ãƒƒãƒ—ã—ãŸå ´åˆã€Day 21ã§ç™»éŒ²ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹
3. Day 21ã§**9é€±é–“åˆ†ã‚’ä¸€æ‹¬èª²é‡‘**ã§ãã‚‹
4. èª²é‡‘æˆåŠŸå¾Œã«current_phaseãŒpaidã«æ›´æ–°ã•ã‚Œã‚‹
5. æœ‰æ–™æœŸé–“ä¸­ã«è§£ç´„ã§ãã‚‹
6. è§£ç´„æ™‚ã«**æ—¥å‰²ã‚Šè¿”é‡‘**ãŒè¨ˆç®—ãƒ»å®Ÿè¡Œã•ã‚Œã‚‹
7. è§£ç´„æ™‚ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã‚‹
8. Webhookã§èª²é‡‘ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
