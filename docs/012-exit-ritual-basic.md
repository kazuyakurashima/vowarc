# 012: Exit Ritualï¼ˆåŸºæœ¬ç‰ˆï¼‰

## æ¦‚è¦

Day 21ã§ã®åœæ­¢é¸æŠæ™‚ã€ã¾ãŸã¯æœ‰æ–™æœŸé–“ä¸­ã®è§£ç´„æ™‚ã«ã€èª å®Ÿã«é–¢ä¿‚ã‚’é–‰ã˜ã‚‹Exit Ritualã®åŸºæœ¬ç‰ˆã‚’å®Ÿè£…ã™ã‚‹ã€‚å­¦ã³ã‚’å›åã—ã€è§£ç´„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—ã™ã‚‹ã€‚

## Phase

**Phase A: MVP**

## å„ªå…ˆåº¦

ä¸­

## ä¾å­˜é–¢ä¿‚

- å‰æ: 007 Day21 Judgment Gate
- å¾Œç¶š: ãªã—ï¼ˆMVPå®Œçµï¼‰

---

## æ©Ÿèƒ½è¦ä»¶ï¼ˆMVPç‰ˆï¼‰

### 1. Exit Ritual ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

- Day 21ã§ã€Œåœæ­¢ã€ã‚’é¸æŠã—ãŸå ´åˆ
- æœ‰æ–™æœŸé–“ä¸­ã«ã€Œè§£ç´„ã€ã‚’é¸æŠã—ãŸå ´åˆ

### 2. åŸºæœ¬ãƒ•ãƒ­ãƒ¼

```
[åœæ­¢/è§£ç´„é¸æŠ] â†’ [å­¦ã³å›åãƒ¬ãƒãƒ¼ãƒˆ] â†’ [è§£ç´„ãƒ¬ãƒ“ãƒ¥ãƒ¼] â†’ [å®Œäº†]
```

### 3. å­¦ã³å›åãƒ¬ãƒãƒ¼ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰

**è¡¨ç¤ºå†…å®¹:**
- å‚åŠ æœŸé–“ã¨çµŒéæ—¥æ•°
- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å›æ•°
- Evidenceæ•°
- AIãŒè¦‹ã¦ã„ãŸå¯èƒ½æ€§ï¼ˆ1æ–‡ï¼‰

### 4. è§£ç´„ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå¿…é ˆï¼‰

**ç†ç”±ã‚«ãƒ†ã‚´ãƒª:**
- åŠ¹æœã‚’æ„Ÿã˜ãªã‹ã£ãŸ
- æ™‚é–“ãŒç¢ºä¿ã§ããªã‹ã£ãŸ
- é‡‘éŠ­çš„ãªç†ç”±
- ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã†
- ç›®æ¨™ã‚’é”æˆã—ãŸ
- ãã®ä»–

**è¿½åŠ è³ªå•ï¼ˆä»»æ„ï¼‰:**
- æœŸå¾…ã¨ã®å·®
- æ¬²ã—ã‹ã£ãŸã‚µãƒãƒ¼ãƒˆ

### 5. èª å®Ÿãªã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°

**è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
ã‚ãªãŸã®å¯èƒ½æ€§ã¯ã¾ã ã“ã“ã«ã‚ã‚Šã¾ã™ã€‚
ã„ã¤ã‹å†ã³æŒ‘æˆ¦ã—ãŸããªã£ãŸæ™‚ã€ã“ã“ã§å¾…ã£ã¦ã„ã¾ã™ã€‚
```

---

## UIè¨­è¨ˆï¼ˆMVPç‰ˆï¼‰

### å­¦ã³å›åãƒ¬ãƒãƒ¼ãƒˆç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã“ã“ã¾ã§ã®æ—…ã‚’æŒ¯ã‚Šè¿”ã‚‹      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  ğŸ“Š ã‚ãªãŸã®æ­©ã¿             â”‚
â”‚  â”œ å‚åŠ æœŸé–“: 21æ—¥é–“          â”‚
â”‚  â”œ ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³: 18å›        â”‚
â”‚  â”” Evidence: 5ä»¶             â”‚
â”‚                              â”‚
â”‚  ğŸ”® AIãŒè¦‹ã¦ã„ãŸå¯èƒ½æ€§       â”‚
â”‚  "ã‚ãªãŸã«ã¯ç¶™ç¶šã™ã‚‹åŠ›ãŒã‚ã‚‹ã€‚â”‚
â”‚   ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ç¶™ç¶šç‡ãŒ        â”‚
â”‚   ãã‚Œã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚"      â”‚
â”‚                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ã“ã®çµŒé¨“ã¯ç„¡é§„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚â”‚
â”‚                              â”‚
â”‚           [æ¬¡ã¸]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§£ç´„ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ€å¾Œã«æ•™ãˆã¦ãã ã•ã„        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  åœæ­¢/è§£ç´„ã®ç†ç”±:            â”‚
â”‚  â—‹ åŠ¹æœã‚’æ„Ÿã˜ãªã‹ã£ãŸ        â”‚
â”‚  â—‹ æ™‚é–“ãŒç¢ºä¿ã§ããªã‹ã£ãŸ    â”‚
â”‚  â—‹ é‡‘éŠ­çš„ãªç†ç”±              â”‚
â”‚  â—‹ ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã†        â”‚
â”‚  â—‹ ç›®æ¨™ã‚’é”æˆã—ãŸ            â”‚
â”‚  â—‹ ãã®ä»–                    â”‚
â”‚                              â”‚
â”‚  æœŸå¾…ã¨ã®å·®ï¼ˆä»»æ„ï¼‰:         â”‚
â”‚  [________________]          â”‚
â”‚                              â”‚
â”‚  æ¬²ã—ã‹ã£ãŸã‚µãƒãƒ¼ãƒˆï¼ˆä»»æ„ï¼‰:  â”‚
â”‚  [________________]          â”‚
â”‚                              â”‚
â”‚           [é€ä¿¡]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Œäº†ç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  ã‚ãªãŸã®å¯èƒ½æ€§ã¯            â”‚
â”‚  ã¾ã ã“ã“ã«ã‚ã‚Šã¾ã™ã€‚        â”‚
â”‚                              â”‚
â”‚  ã„ã¤ã‹å†ã³æŒ‘æˆ¦ã—ãŸããªã£ãŸ  â”‚
â”‚  æ™‚ã€ã“ã“ã§å¾…ã£ã¦ã„ã¾ã™ã€‚    â”‚
â”‚                              â”‚
â”‚           [é–‰ã˜ã‚‹]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### exit_rituals ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE exit_rituals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  trigger VARCHAR(50) NOT NULL, -- 'day21_stop' | 'cancellation'
  day_count INTEGER NOT NULL,
  checkin_count INTEGER NOT NULL,
  evidence_count INTEGER NOT NULL,
  potential_statement TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### exit_reviews ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ008ã§å®šç¾©æ¸ˆã¿ï¼‰

> **Note:** exit_reviews ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ 008-payment-system.md ã§å®šç¾©æ¸ˆã¿ã€‚
> Exit Ritualã‹ã‚‰ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã™ã‚‹ã€‚

```sql
-- 008-payment-system.md ã§å®šç¾©æ¸ˆã¿
-- exit_type: 'graduation' | 'trial_stop' | 'refund'
-- Exit Ritualã®å ´åˆã¯ exit_type = 'trial_stop' ã¾ãŸã¯ 'graduation'

-- exit_ritual_id ã‚’è¿½åŠ ã™ã‚‹å ´åˆã®æ‹¡å¼µï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
ALTER TABLE exit_reviews
ADD COLUMN exit_ritual_id UUID REFERENCES exit_rituals(id);
```

---

## APIè¨­è¨ˆ

### GET /api/exit-ritual/summary

Exit Ritualç”¨ã®ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

**Response:**
```json
{
  "day_count": 21,
  "checkin_count": 18,
  "evidence_count": 5,
  "potential_statement": "ã‚ãªãŸã«ã¯ç¶™ç¶šã™ã‚‹åŠ›ãŒã‚ã‚‹ã€‚ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ç¶™ç¶šç‡ãŒãã‚Œã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚"
}
```

### POST /api/exit-ritual/complete

Exit Ritualã‚’å®Œäº†

**Request:**
```json
{
  "trigger": "day21_stop",
  "review": {
    "reason_category": "æ™‚é–“ãŒç¢ºä¿ã§ããªã‹ã£ãŸ",
    "expectation_gap": "...",
    "missing_support": "..."
  }
}
```

---

## Potential Statementç”Ÿæˆ

```typescript
async function generatePotentialStatement(
  userId: string,
  metrics: ExitMetrics
): Promise<string> {
  const prompt = `
ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®Ÿç¸¾ã‹ã‚‰ã€å¯èƒ½æ€§ã‚’ç¤ºã™1æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€å®Ÿç¸¾ã€‘
- å‚åŠ æœŸé–“: ${metrics.day_count}æ—¥
- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å›æ•°: ${metrics.checkin_count}å›
- Evidenceæå‡º: ${metrics.evidence_count}ä»¶

ã€æ¡ä»¶ã€‘
- ãƒã‚¸ãƒ†ã‚£ãƒ–ã ãŒéåº¦ã§ãªã„
- å…·ä½“çš„ãªæ•°å€¤ã‚’å¼•ç”¨ã™ã‚‹
- å°†æ¥ã¸ã®å¯èƒ½æ€§ã‚’ç¤ºå”†ã™ã‚‹
- 1æ–‡ã§ç°¡æ½”ã«

ã€å‡ºåŠ›å½¢å¼ã€‘
1æ–‡ã®Potential Statement
`;

  // AIç”Ÿæˆ
}
```

---

## Todo

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
- [ ] exit_rituals ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] exit_reviews ãƒ†ãƒ¼ãƒ–ãƒ«ã« exit_ritual_id ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆ008ã§å®šç¾©æ¸ˆã¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‹¡å¼µï¼‰

### ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
- [ ] æœŸé–“ãƒ»å›æ•°ã®è¨ˆç®—
- [ ] Potential Statementç”Ÿæˆï¼ˆAIï¼‰

### UIå®Ÿè£…
- [ ] å­¦ã³å›åãƒ¬ãƒãƒ¼ãƒˆç”»é¢
- [ ] è§£ç´„ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢
- [ ] å®Œäº†ç”»é¢

### APIå®Ÿè£…
- [ ] GET /api/exit-ritual/summary
- [ ] POST /api/exit-ritual/complete

### é€£æº
- [ ] Day21ã‹ã‚‰ã®é·ç§»
- [ ] è§£ç´„ç”»é¢ã‹ã‚‰ã®é·ç§»
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºæ›´æ–°ï¼ˆterminatedï¼‰

---

## å®Œäº†æ¡ä»¶

1. Day21åœæ­¢æ™‚ã«Exit RitualãŒè¡¨ç¤ºã•ã‚Œã‚‹
2. å­¦ã³å›åãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
3. è§£ç´„ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…é ˆå…¥åŠ›ã•ã‚Œã‚‹
4. Potential StatementãŒç”Ÿæˆã•ã‚Œã‚‹
5. èª å®Ÿãªã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚§ãƒ¼ã‚ºãŒé©åˆ‡ã«æ›´æ–°ã•ã‚Œã‚‹
