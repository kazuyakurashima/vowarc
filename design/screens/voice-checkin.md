# Voice Check-in Screen Specification

## 概要

音声中心のチェックイン体験。Orb UIによる抽象的な表現、Mirror Feedbackの提供、If-Then記録を行う。

**関連チケット:** 004-voice-checkin.md

---

## 1. 画面フロー

```
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│   1. Recording    │ ──▶ │   2. Processing   │ ──▶ │   3. Feedback     │
│   (音声録音)       │     │   (AI処理中)       │     │   (Mirror表示)    │
└───────────────────┘     └───────────────────┘     └───────────────────┘
                                                            │
                                                            ▼
                                    ┌───────────────────┐
                                    │   4. If-Then      │
                                    │   (記録質問)       │
                                    └───────────────────┘
                                            │
                                            ▼
                                    ┌───────────────────┐
                                    │   5. Complete     │
                                    │   (完了)          │
                                    └───────────────────┘
```

---

## 2. 画面構成

### 2.1 Recording Screen（録音画面）

```
┌─────────────────────────────────────────┐
│                                          │
│           [×] 閉じる                     │ ← 左上
│                                          │
│                                          │
│                                          │
│              ╭───────────╮               │
│              │           │               │
│              │    Orb    │               │ ← 120x120px
│              │           │               │
│              ╰───────────╯               │
│                                          │
│                                          │
│         「今日はどうでしたか？」          │ ← プロンプト
│                                          │
│                                          │
│           [録音中: 0:45]                 │ ← 経過時間
│                                          │
│                                          │
│        [📤 送信]    [⌨️ テキストへ]      │
│                                          │
└─────────────────────────────────────────┘
```

### 2.2 Processing Screen（処理中）

```
┌─────────────────────────────────────────┐
│                                          │
│                                          │
│                                          │
│              ╭───────────╮               │
│              │           │               │
│              │    Orb    │               │ ← 回転アニメーション
│              │ (spinning)│               │
│              ╰───────────╯               │
│                                          │
│                                          │
│           分析しています...               │
│                                          │
│    ─────────────────────────────         │ ← Subtitles (40%)
│    「今日は朝起きるのが辛かったけど...」   │
│    ─────────────────────────────         │
│                                          │
│                                          │
└─────────────────────────────────────────┘
```

### 2.3 Feedback Screen（Mirror Feedback）

```
┌─────────────────────────────────────────┐
│                                          │
│  Mirror Feedback                         │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │ 💡 Observed Change                  │ │
│  │ 朝の起床時間が安定してきています     │ │
│  └────────────────────────────────────┘ │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │ 🔬 Hypothesis                       │ │
│  │ 夜のスマホ時間を減らしたことが      │ │
│  │ 影響している可能性があります        │ │
│  └────────────────────────────────────┘ │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │ 🧪 Next Experiment                  │ │
│  │ 明日も22時以降はスマホを            │ │
│  │ 別室に置いてみましょう              │ │
│  └────────────────────────────────────┘ │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │ 🔗 Evidence Links                   │ │
│  │ 1/5: 朝5時起床達成                  │ │
│  │ 1/8: スマホ制限開始                 │ │
│  └────────────────────────────────────┘ │
│                                          │
│             [続ける]                     │
│                                          │
└─────────────────────────────────────────┘
```

### 2.4 If-Then Recording Screen

```
┌─────────────────────────────────────────┐
│                                          │
│  If-Then確認                             │
│                                          │
│  今日、予定していた障害（誘惑、時間不足等）│
│  に遭遇しましたか？                       │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │ ○ はい                              │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │ ○ いいえ                            │ │
│  └────────────────────────────────────┘ │
│                                          │
│  ─────────────────────────────────────  │
│  （「はい」選択時のみ表示）               │
│                                          │
│  事前に決めていたIf-Thenを               │
│  実行できましたか？                       │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │ ○ 実行できた                        │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │ ○ 実行できなかった                  │ │
│  └────────────────────────────────────┘ │
│                                          │
│             [完了]                       │
│                                          │
└─────────────────────────────────────────┘
```

---

## 3. Orb UI 仕様

### 3.1 基本設計

- **形状:** 円形、120x120px
- **アバターなし:** 抽象的な表現のみ
- **グラデーション:** radial-gradient from accent to background

### 3.2 状態別アニメーション

| 状態 | アニメーション | 速度 |
|---|---|---|
| 待機中 | 呼吸するような脈動 | 4秒サイクル |
| 録音中 | 音量連動の脈動 + 波紋 | リアルタイム |
| 処理中 | ゆっくり回転 | 8秒/1回転 |
| 完了 | 静止 + フェード | 1秒 |

### 3.3 Orbアニメーション詳細

**待機中（Breathing）:**
```css
animation: breathe 4s ease-in-out infinite;
@keyframes breathe {
  0%, 100% { transform: scale(1); opacity: 0.8; }
  50% { transform: scale(1.05); opacity: 1; }
}
```

**録音中（Listening）:**
- 音量（dB）を0-1にノーマライズ
- scale: 1 + (volume * 0.15)
- 波紋: 音量閾値を超えたら発生

**処理中（Processing）:**
```css
animation: rotate 8s linear infinite;
@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
```

---

## 4. Subtitles 仕様

### 4.1 表示ルール

- **透過度:** 40%
- **位置:** 画面中央やや下
- **フォント:** Noto Sans JP, 14px
- **最大行数:** 3行
- **表示タイミング:** STT結果をリアルタイム表示

### 4.2 フェード効果

- 新しいテキスト: フェードイン 300ms
- 古いテキスト: 上にスクロールしてフェードアウト

---

## 5. デザイン仕様

### 5.1 カラー適用

| 要素 | カラー | トークン |
|---|---|---|
| 背景 | #F7F3F0 | colors.background |
| Orb グラデーション中心 | #E07A5F | colors.accent |
| Orb グラデーション外周 | #F7F3F0 | colors.background |
| テキスト | #2C2C2C | colors.textPrimary |
| Subtitles | rgba(44,44,44,0.4) | textPrimary @ 40% |
| Mirror Feedbackカード | #FAF8F5 | colors.surface |

### 5.2 タイポグラフィ

| 要素 | フォント | サイズ | Weight |
|---|---|---|---|
| プロンプト | Noto Serif JP | 18px | Light |
| 経過時間 | Inter | 14px | Regular |
| Subtitles | Noto Sans JP | 14px | Regular |
| Mirror見出し | Noto Sans JP | 14px | Medium |
| Mirror本文 | Noto Sans JP | 16px | Regular |

### 5.3 ハプティクス

| タイミング | フィードバック | トークン |
|---|---|---|
| 録音開始 | medium | haptics.medium |
| 録音中 (60bpm) | light | haptics.reflectionPulse |
| 送信タップ | medium | haptics.medium |
| 完了 | vowImpact | haptics.vowImpact |

---

## 6. Mirror Feedback 4要素

### 6.1 必須表示項目

1. **Observed Change（観測変化）**
   - ユーザーの行動/状態の変化を客観的に記述
   - 例: 「朝の起床時間が安定してきています」

2. **Hypothesis（仮説）**
   - 変化の原因についての仮説
   - 例: 「夜のスマホ時間を減らしたことが影響している可能性があります」

3. **Next Experiment（次の実験）**
   - 次に試すべきアクション
   - 例: 「明日も22時以降はスマホを別室に置いてみましょう」

4. **Evidence Links（証拠リンク）**
   - 関連するEvidence Journalエントリへのリンク
   - 例: 「1/5: 朝5時起床達成」

### 6.2 表示順序

1. Observed Change
2. Hypothesis
3. Next Experiment
4. Evidence Links

**各カード間:** 16px（spacing.md）

---

## 7. If-Then記録

### 7.1 質問フロー

```typescript
interface IfThenRecord {
  encounteredObstacle: boolean;
  executedIfThen?: boolean; // encounteredObstacle=trueの場合のみ
}
```

### 7.2 保存データ

```sql
UPDATE checkins
SET if_then_triggered = $executedIfThen
WHERE id = $checkinId;
```

### 7.3 UI仕様

- ラジオボタン形式
- 選択時: haptics.light
- 「はい」選択で第2質問がスライドイン表示

---

## 8. 沈黙許容設計

### 8.1 原則

- ユーザーが黙っても急かさない
- タイムアウトなし（ユーザーが明示的に送信するまで待機）
- 沈黙中もOrbは穏やかに脈動

### 8.2 長時間沈黙時

- 60秒後: 控えめなヒント表示（オプション）
  - 「思いつくままに話してみてください」
- プレッシャーを与えない

---

## 9. エラー処理

### 9.1 マイクアクセス拒否

- エラーメッセージ表示
- 「テキストで入力」への誘導
- 設定画面への遷移ボタン

### 9.2 ネットワークエラー

- リトライボタン表示
- 音声データはローカルに一時保存
- オフライン時はテキスト入力へフォールバック

### 9.3 STT失敗

- 「文字起こしに失敗しました」メッセージ
- 「再録音」または「テキストで入力」オプション

---

## 10. アクセシビリティ

### 10.1 VoiceOver対応

- Orb: 「音声録音ボタン、ダブルタップで録音開始」
- 録音中: 「録音中、経過時間 45秒」
- Mirror Feedback: 各カードを順次読み上げ

### 10.2 代替手段

- 「テキストで入力」ボタン常時表示
- キーボードナビゲーション対応

---

## 11. 実装メモ

### 11.1 必要なライブラリ

- **Expo AV:** 音声録音
- **OpenAI Whisper API / react-native-voice:** STT
- **react-native-reanimated:** Orbアニメーション
- **expo-haptics:** 触覚フィードバック

### 11.2 コンポーネント構成

```
VoiceCheckin/
├── RecordingScreen.tsx
├── ProcessingScreen.tsx
├── FeedbackScreen.tsx
├── IfThenScreen.tsx
├── CompleteScreen.tsx
├── components/
│   ├── Orb.tsx
│   ├── Subtitles.tsx
│   ├── MirrorFeedbackCard.tsx
│   └── IfThenQuestion.tsx
└── hooks/
    ├── useAudioRecording.ts
    ├── useSTT.ts
    └── useHaptics.ts
```

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|---|---|---|
| v0.1 | 2025-01-09 | 初版作成 |
